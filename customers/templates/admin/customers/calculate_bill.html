{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
  .billing-results {
    margin-top: 20px;
  }

  .billing-month {
    margin-bottom: 30px;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 4px;
  }

  .billing-month h3 {
    margin-top: 0;
    color: #417690;
  }

  .billing-month table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  .billing-month th,
  .billing-month td {
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  .billing-month th {
    background: #f0f0f0;
    font-weight: bold;
  }

  .billing-month .amount {
    text-align: right;
    font-family: monospace;
  }

  .billing-month .total td {
    font-weight: bold;
    border-top: 2px solid #417690;
    background: #e8f4f8;
  }

  .billing-month .charge-type {
    color: #666;
    font-size: 0.9em;
  }

  .warnings {
    background: #fff3cd;
    border: 1px solid #ffc107;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 4px;
  }

  .warnings ul {
    margin: 5px 0 0 20px;
    padding: 0;
  }

  .error-message {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 4px;
    color: #721c24;
  }

  .summary-box {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    padding: 15px;
    margin-top: 20px;
    border-radius: 4px;
  }

  .summary-box h3 {
    margin-top: 0;
    color: #155724;
  }

  .grand-total {
    font-size: 1.5em;
    font-weight: bold;
    color: #155724;
  }

  .gap-analysis-warning {
    background: #fff3cd;
    border: 1px solid #ffc107;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 4px;
  }

  .gap-analysis-warning h3 {
    margin-top: 0;
    color: #856404;
  }

  .gap-analysis-warning table {
    width: auto;
    margin-top: 10px;
  }

  .gap-analysis-warning th,
  .gap-analysis-warning td {
    padding: 4px 12px;
    border: 1px solid #ffc107;
  }

  .billing-charts {
    margin-top: 30px;
    max-width: 1400px;
  }

  .chart-container {
    margin-bottom: 30px;
    padding: 15px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
  }

  .chart-container h3 {
    margin-top: 0;
    color: #417690;
  }

  .chart-container .js-plotly-plot {
    width: 100% !important;
    max-width: 100%;
  }

  .chart-container .plotly {
    max-width: 100%;
  }

  .daily-detail-section {
    margin-top: 30px;
    padding: 20px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  .daily-detail-section h3 {
    margin-top: 0;
    color: #417690;
  }

  .daily-detail-controls {
    margin-bottom: 20px;
    padding: 15px;
    background: #f5f5f5;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
  }

  .daily-detail-controls label {
    font-weight: bold;
    color: #333;
  }

  .daily-detail-controls select {
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    min-width: 150px;
  }

  .daily-detail-controls button {
    padding: 8px 16px;
    background: #417690;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }

  .daily-detail-controls button:hover {
    background: #205067;
  }

  .daily-detail-chart {
    margin-bottom: 20px;
    padding: 15px;
    background: #fafafa;
    border: 1px solid #eee;
    border-radius: 4px;
  }

  .daily-detail-chart h4 {
    margin-top: 0;
    color: #555;
    font-size: 14px;
  }

  .period-legend {
    margin-top: 10px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 4px;
    font-size: 12px;
  }

  .period-legend-item {
    display: inline-flex;
    align-items: center;
    margin-right: 15px;
    margin-bottom: 5px;
  }

  .period-legend-color {
    width: 20px;
    height: 12px;
    margin-right: 5px;
    border-radius: 2px;
    opacity: 0.3;
    border: 1px solid rgba(0,0,0,0.3);
  }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
  &rsaquo; <a href="{% url 'admin:customers_customer_changelist' %}">Customers</a>
  &rsaquo; <a href="{% url 'admin:customers_customer_change' customer.pk %}">{{ customer.name }}</a>
  &rsaquo; Calculate Bill
</div>
{% endblock %}

{% block content %}
<div class="module">
  <h2>Calculate Bill for {{ customer.name }}</h2>
  <p>
    <strong>Tariff:</strong> {{ customer.current_tariff }}<br>
    <strong>Timezone:</strong> {{ customer.timezone }}<br>
    <strong>Billing Day:</strong> {{ customer.billing_day }} of each month
  </p>

  <form method="post">
    {% csrf_token %}

    {% if form.non_field_errors %}
    <div class="errors">
      {{ form.non_field_errors }}
    </div>
    {% endif %}

    <div class="form-row">
      <div style="display: inline-block; margin-right: 20px;">
        <label for="{{ form.start_billing_month.id_for_label }}">{{ form.start_billing_month.label }}:</label>
        {{ form.start_billing_month }}
        {% if form.start_billing_month.errors %}
        <p class="errornote">{{ form.start_billing_month.errors }}</p>
        {% endif %}
      </div>
      <div style="display: inline-block;">
        <label for="{{ form.end_billing_month.id_for_label }}">{{ form.end_billing_month.label }}:</label>
        {{ form.end_billing_month }}
        {% if form.end_billing_month.errors %}
        <p class="errornote">{{ form.end_billing_month.errors }}</p>
        {% endif %}
      </div>
    </div>

    <div class="submit-row">
      <input type="submit" value="Calculate Bill" class="default">
      <a href="{% url 'admin:customers_customer_change' customer.pk %}" class="button cancel-link">Back to Customer</a>
    </div>
  </form>
</div>

{% if error_message %}
<div class="error-message">
  <strong>Error:</strong> {{ error_message }}
</div>
{% endif %}

{% if billing_result %}
<div class="billing-results">
  <h2>Billing Results</h2>

  <p>
    <strong>Period:</strong> {{ billing_result.period_start }} to {{ billing_result.period_end }}<br>
    <strong>Tariff Used:</strong> {{ billing_result.tariff }}
  </p>

  {% if billing_result.gap_analysis and billing_result.gap_analysis.total_missing > 0 %}
  <div class="gap-analysis-warning">
    <h3>Data Quality Warning</h3>
    <p>
      <strong>Total Missing Intervals:</strong> {{ billing_result.gap_analysis.total_missing }}<br>
      <strong>Longest Gap:</strong> {{ billing_result.gap_analysis.longest_gap_intervals }} intervals
      ({{ billing_result.gap_analysis.longest_gap_duration }})<br>
      Missing data was filled using forward-fill (last known value).
    </p>
    {% if billing_result.gap_analysis.missing_by_month %}
    <table>
      <thead>
        <tr>
          <th>Month</th>
          <th>Missing Intervals</th>
        </tr>
      </thead>
      <tbody>
        {% for month, count in billing_result.gap_analysis.missing_by_month.items %}
        <tr>
          <td>{{ month }}</td>
          <td>{{ count }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>
  {% endif %}

  {% if billing_result.warnings %}
  <div class="warnings">
    <strong>Warnings:</strong>
    <ul>
      {% for warning in billing_result.warnings %}
      <li>{{ warning }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  {% if chart_data.months %}
  <div class="billing-charts">
    <h2>Billing Visualizations</h2>

    <div class="chart-container">
      <h3>Monthly Charges Breakdown</h3>
      <div id="stacked-bar-chart" style="width: 100%; height: 700px;"></div>
    </div>

    <div class="chart-container">
      <h3>Energy Charges Over Time</h3>
      <div id="energy-line-chart" style="width: 100%; height: 600px;"></div>
    </div>

    <div class="chart-container">
      <h3>Demand Charges Over Time</h3>
      <div id="demand-line-chart" style="width: 100%; height: 600px;"></div>
    </div>

    <div class="chart-container">
      <h3>Daily Usage</h3>
      <div id="daily-usage-chart" style="width: 100%; height: 600px;"></div>
    </div>

    <div class="daily-detail-section">
      <h3>Daily Detail View</h3>
      <p>View interval-level usage data for a specific day with charge period overlays.</p>

      <div class="daily-detail-controls">
        <label for="detail-date-select">Select Date:</label>
        <select id="detail-date-select">
          <option value="">-- Choose a date --</option>
        </select>
        <button type="button" id="jump-to-peak-btn">Jump to Peak Demand Day</button>
        <span id="peak-day-info" style="color: #666; font-size: 13px;"></span>
      </div>

      <div class="daily-detail-chart">
        <h4>Energy Usage (kWh per interval)</h4>
        <div id="daily-energy-detail-chart" style="width: 100%; height: 400px;"></div>
        <div id="energy-period-legend" class="period-legend"></div>
      </div>

      <div class="daily-detail-chart">
        <h4>Peak Demand (kW per interval)</h4>
        <div id="daily-demand-detail-chart" style="width: 100%; height: 400px;"></div>
        <div id="demand-period-legend" class="period-legend"></div>
      </div>
    </div>
  </div>
  {% endif %}

  <h2>Monthly Breakdown</h2>
  {% for month in billing_result.billing_months %}
  <div class="billing-month">
    <h3>Billing Period: {{ month.period_start }} to {{ month.period_end }}</h3>
    <table>
      <thead>
        <tr>
          <th>Charge Type</th>
          <th>Description</th>
          <th class="amount">Amount</th>
        </tr>
      </thead>
      <tbody>
        {% for item in month.energy_line_items %}
        <tr>
          <td class="charge-type">Energy</td>
          <td>{{ item.description }}</td>
          <td class="amount">${{ item.amount_usd|floatformat:2 }}</td>
        </tr>
        {% endfor %}
        {% for item in month.demand_line_items %}
        <tr>
          <td class="charge-type">Demand</td>
          <td>{{ item.description }}</td>
          <td class="amount">${{ item.amount_usd|floatformat:2 }}</td>
        </tr>
        {% endfor %}
        {% for item in month.customer_line_items %}
        <tr>
          <td class="charge-type">Customer</td>
          <td>{{ item.description }}</td>
          <td class="amount">${{ item.amount_usd|floatformat:2 }}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr class="total">
          <td colspan="2"><strong>Monthly Total</strong></td>
          <td class="amount">${{ month.total_usd|floatformat:2 }}</td>
        </tr>
      </tfoot>
    </table>
  </div>
  {% empty %}
  <p>No billing data for the selected period.</p>
  {% endfor %}

  {% if billing_result.billing_months %}
  <div class="summary-box">
    <h3>Summary</h3>
    <p>
      <strong>Billing Months:</strong> {{ billing_result.billing_months|length }}<br>
      <span class="grand-total">Grand Total: ${{ billing_result.grand_total_usd|floatformat:2 }}</span>
    </p>
  </div>
  {% endif %}
</div>

{% if chart_data.months %}
<script>
  (function () {
    const chartData = {{ chart_data_json | safe }};
    if (!chartData.months || chartData.months.length === 0) return;

  // Color palettes
  const energyColors = ['#1f77b4', '#aec7e8', '#6baed6', '#3182bd', '#9ecae1'];
  const demandColors = ['#ff7f0e', '#ffbb78', '#fd8d3c', '#e6550d', '#fdae6b'];
  const customerColors = ['#2ca02c', '#98df8a', '#74c476', '#31a354', '#a1d99b'];

  // 1. STACKED BAR CHART
  const barTraces = [];
  let colorIdx = 0;

  // Energy charges
  for (const [name, values] of Object.entries(chartData.stacked_bar.energy_charges)) {
    barTraces.push({
      x: chartData.months,
      y: values,
      name: name + ' (Energy)',
      type: 'bar',
      marker: { color: energyColors[colorIdx % energyColors.length] }
    });
    colorIdx++;
  }

  // Demand charges
  colorIdx = 0;
  for (const [name, values] of Object.entries(chartData.stacked_bar.demand_charges)) {
    barTraces.push({
      x: chartData.months,
      y: values,
      name: name + ' (Demand)',
      type: 'bar',
      marker: { color: demandColors[colorIdx % demandColors.length] }
    });
    colorIdx++;
  }

  // Customer charges
  colorIdx = 0;
  for (const [name, values] of Object.entries(chartData.stacked_bar.customer_charges)) {
    barTraces.push({
      x: chartData.months,
      y: values,
      name: name + ' (Customer)',
      type: 'bar',
      marker: { color: customerColors[colorIdx % customerColors.length] }
    });
    colorIdx++;
  }

  Plotly.newPlot('stacked-bar-chart', barTraces, {
    barmode: 'stack',
    autosize: true,
    title: { text: 'Monthly Charges by Type', font: { size: 16 } },
    xaxis: { title: 'Billing Month', automargin: true },
    yaxis: { title: 'Amount ($)', tickprefix: '$', automargin: true },
    legend: { orientation: 'h', y: -0.3, font: { size: 11 } },
    margin: { l: 60, r: 20, t: 50, b: 120 },
    hoverlabel: { namelength: -1, font: { size: 13 } },
    hovermode: 'x unified'
  }, { responsive: true, displaylogo: false });

  // 2. ENERGY LINE CHART
  const energyTraces = [];
  if (chartData.energy_line.total.some(v => v > 0)) {
    energyTraces.push({
      x: chartData.months,
      y: chartData.energy_line.total,
      name: 'Total Energy',
      mode: 'lines+markers',
      line: { width: 3, color: '#1f77b4' },
      marker: { size: 8 }
    });

    colorIdx = 1;
    for (const [name, values] of Object.entries(chartData.energy_line.components)) {
      energyTraces.push({
        x: chartData.months,
        y: values,
        name: name,
        mode: 'lines+markers',
        line: { width: 1, dash: 'dot', color: energyColors[colorIdx % energyColors.length] },
        marker: { size: 5 }
      });
      colorIdx++;
    }

    Plotly.newPlot('energy-line-chart', energyTraces, {
      autosize: true,
      title: { text: 'Energy Charges by Month', font: { size: 16 } },
      xaxis: { title: 'Billing Month', automargin: true },
      yaxis: { title: 'Amount ($)', tickprefix: '$', automargin: true },
      legend: { orientation: 'h', y: -0.3, font: { size: 11 } },
      margin: { l: 60, r: 20, t: 50, b: 100 },
      hoverlabel: { namelength: -1, font: { size: 13 } },
      hovermode: 'x unified'
    }, { responsive: true, displaylogo: false });
  } else {
    document.getElementById('energy-line-chart').innerHTML = '<p style="text-align: center; color: #666;">No energy charges in this period.</p>';
  }

  // 3. DEMAND LINE CHART
  const demandTraces = [];
  if (chartData.demand_line.total.some(v => v > 0)) {
    demandTraces.push({
      x: chartData.months,
      y: chartData.demand_line.total,
      name: 'Total Demand',
      mode: 'lines+markers',
      line: { width: 3, color: '#ff7f0e' },
      marker: { size: 8 }
    });

    colorIdx = 1;
    for (const [name, values] of Object.entries(chartData.demand_line.components)) {
      demandTraces.push({
        x: chartData.months,
        y: values,
        name: name,
        mode: 'lines+markers',
        line: { width: 1, dash: 'dot', color: demandColors[colorIdx % demandColors.length] },
        marker: { size: 5 }
      });
      colorIdx++;
    }

    Plotly.newPlot('demand-line-chart', demandTraces, {
      autosize: true,
      title: { text: 'Demand Charges by Month', font: { size: 16 } },
      xaxis: { title: 'Billing Month', automargin: true },
      yaxis: { title: 'Amount ($)', tickprefix: '$', automargin: true },
      legend: { orientation: 'h', y: -0.3, font: { size: 11 } },
      margin: { l: 60, r: 20, t: 50, b: 100 },
      hoverlabel: { namelength: -1, font: { size: 13 } },
      hovermode: 'x unified'
    }, { responsive: true, displaylogo: false });
  } else {
    document.getElementById('demand-line-chart').innerHTML = '<p style="text-align: center; color: #666;">No demand charges in this period.</p>';
  }

  // 4. DAILY USAGE CHART
  if (chartData.daily_usage && chartData.daily_usage.dates.length > 0) {
    // Find days with demand charges for triangle markers
    const demandChargeDetails = chartData.daily_usage.demand_charge_details || {};
    const chargeDates = [];
    const chargeYValues = [];
    const chargeHoverTexts = [];
    const maxKwh = Math.max(...chartData.daily_usage.total_kwh);
    const maxKw = Math.max(...chartData.daily_usage.max_kw);
    // Scale factor to convert kW to kWh-equivalent position on y1 axis
    const kwToKwhScale = maxKw > 0 ? maxKwh / maxKw : 1;

    chartData.daily_usage.dates.forEach((date, i) => {
      if (demandChargeDetails[date]) {
        chargeDates.push(date);
        // Position triangle above the higher of kWh bar or kW line (scaled to y1)
        const kwhValue = chartData.daily_usage.total_kwh[i];
        const kwEquivalent = chartData.daily_usage.max_kw[i] * kwToKwhScale;
        chargeYValues.push(Math.max(kwhValue, kwEquivalent) + maxKwh * 0.03);
        // Build hover text with charge details
        const charges = demandChargeDetails[date];
        const chargeLines = charges.map(c => `${c.name}: $${c.amount.toFixed(2)}`).join('<br>');
        chargeHoverTexts.push(`<b>Demand Charges</b><br>${chargeLines}`);
      }
    });

    const dailyTraces = [
      {
        x: chartData.daily_usage.dates,
        y: chartData.daily_usage.total_kwh,
        name: 'Total kWh',
        type: 'bar',
        marker: { color: '#2ca02c' },
        yaxis: 'y1'
      },
      {
        x: chartData.daily_usage.dates,
        y: chartData.daily_usage.max_kw,
        name: 'Max kW',
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#d62728', width: 2 },
        marker: { size: 4 },
        yaxis: 'y2'
      }
    ];

    // Add demand charge day markers if any exist
    if (chargeDates.length > 0) {
      dailyTraces.push({
        x: chargeDates,
        y: chargeYValues,
        name: 'Demand Charge Day',
        type: 'scatter',
        mode: 'markers',
        marker: {
          symbol: 'triangle-up',
          size: 14,
          color: '#ff7f0e',
          line: { color: '#000', width: 1 }
        },
        yaxis: 'y1',
        text: chargeHoverTexts,
        hovertemplate: '%{text}<extra></extra>'
      });
    }

    // Build vertical lines for billing period boundaries
    const billingPeriodShapes = (chartData.daily_usage.billing_period_ends || []).map(date => ({
      type: 'line',
      x0: date,
      x1: date,
      y0: 0,
      y1: 1,
      yref: 'paper',
      line: { color: '#888', width: 1, dash: 'dash' }
    }));

    Plotly.newPlot('daily-usage-chart', dailyTraces, {
      autosize: true,
      title: { text: 'Daily Energy & Peak Demand', font: { size: 16 } },
      xaxis: { title: 'Date', automargin: true, type: 'date' },
      yaxis: {
        title: 'Energy (kWh)',
        titlefont: { color: '#2ca02c' },
        tickfont: { color: '#2ca02c' },
        automargin: true
      },
      yaxis2: {
        title: 'Peak Demand (kW)',
        titlefont: { color: '#d62728' },
        tickfont: { color: '#d62728' },
        overlaying: 'y',
        side: 'right',
        automargin: true
      },
      legend: { orientation: 'h', y: -0.2, font: { size: 11 } },
      margin: { l: 60, r: 60, t: 50, b: 80 },
      hoverlabel: { namelength: -1, font: { size: 13 } },
      hovermode: 'x unified',
      shapes: billingPeriodShapes
    }, { responsive: true, displaylogo: false });
  } else {
    document.getElementById('daily-usage-chart').innerHTML = '<p style="text-align: center; color: #666;">No daily usage data available.</p>';
  }

  // 5. DAILY DETAIL CHARTS
  if (chartData.daily_detail && chartData.daily_detail.available_dates.length > 0) {
    const dateSelect = document.getElementById('detail-date-select');
    const peakBtn = document.getElementById('jump-to-peak-btn');
    const peakInfo = document.getElementById('peak-day-info');
    const dailyDetail = chartData.daily_detail;

    // Populate date dropdown
    dailyDetail.available_dates.forEach(date => {
      const option = document.createElement('option');
      option.value = date;
      option.textContent = date;
      dateSelect.appendChild(option);
    });

    // Show peak demand day info
    if (dailyDetail.peak_demand_day) {
      peakInfo.textContent = `(Peak: ${dailyDetail.peak_demand_day})`;
    } else {
      peakBtn.disabled = true;
      peakBtn.style.opacity = '0.5';
      peakInfo.textContent = '(No demand charges)';
    }

    // Render detail charts for a given date
    function renderDailyDetail(selectedDate) {
      const data = dailyDetail.by_date[selectedDate];
      if (!data || data.timestamps.length === 0) {
        document.getElementById('daily-energy-detail-chart').innerHTML =
          '<p style="text-align: center; color: #666; padding: 40px;">No data for this date.</p>';
        document.getElementById('daily-demand-detail-chart').innerHTML =
          '<p style="text-align: center; color: #666; padding: 40px;">No data for this date.</p>';
        document.getElementById('energy-period-legend').innerHTML = '';
        document.getElementById('demand-period-legend').innerHTML = '';
        return;
      }

      const plotlyConfig = { responsive: true, displaylogo: false };

      // Helper to create period shapes and legend
      function createPeriodShapes(periods, selectedDate) {
        const shapes = [];
        periods.forEach(period => {
          // Convert HH:MM to full datetime
          const startTime = period.start === '24:00' ? '23:59' : period.start;
          const endTime = period.end === '24:00' ? '23:59' : period.end;
          const x0 = `${selectedDate}T${startTime}`;
          const x1 = `${selectedDate}T${endTime}`;

          shapes.push({
            type: 'rect',
            xref: 'x',
            yref: 'paper',
            x0: x0,
            x1: x1,
            y0: 0,
            y1: 1,
            fillcolor: period.color,
            opacity: 0.2,
            line: { width: 1, color: period.color }
          });
        });
        return shapes;
      }

      // Helper to create legend HTML
      function createLegendHtml(periods) {
        if (periods.length === 0) {
          return '<em>No charge periods apply to this day.</em>';
        }
        return periods.map(p =>
          `<span class="period-legend-item">
            <span class="period-legend-color" style="background-color: ${p.color};"></span>
            ${p.name} (${p.start} - ${p.end})
          </span>`
        ).join('');
      }

      // Energy Detail Chart
      const energyShapes = createPeriodShapes(data.energy_periods, selectedDate);
      const energyTrace = {
        x: data.timestamps,
        y: data.kwh,
        name: 'Energy (kWh)',
        type: 'scatter',
        mode: 'lines',
        line: { color: '#2ca02c', width: 2 },
        fill: 'tozeroy',
        fillcolor: 'rgba(44, 160, 44, 0.1)'
      };

      Plotly.newPlot('daily-energy-detail-chart', [energyTrace], {
        autosize: true,
        title: { text: `Energy Usage - ${selectedDate}`, font: { size: 14 } },
        xaxis: {
          title: 'Time',
          type: 'date',
          tickformat: '%H:%M',
          automargin: true
        },
        yaxis: {
          title: 'Energy (kWh)',
          automargin: true
        },
        margin: { l: 60, r: 20, t: 40, b: 60 },
        hoverlabel: { namelength: -1, font: { size: 13 } },
        hovermode: 'x unified',
        shapes: energyShapes
      }, plotlyConfig);

      document.getElementById('energy-period-legend').innerHTML =
        '<strong>Energy Charge Periods:</strong> ' + createLegendHtml(data.energy_periods);

      // Demand Detail Chart
      const demandShapes = createPeriodShapes(data.demand_periods, selectedDate);
      const demandTrace = {
        x: data.timestamps,
        y: data.kw,
        name: 'Demand (kW)',
        type: 'scatter',
        mode: 'lines',
        line: { color: '#d62728', width: 2 },
        fill: 'tozeroy',
        fillcolor: 'rgba(214, 39, 40, 0.1)'
      };

      Plotly.newPlot('daily-demand-detail-chart', [demandTrace], {
        autosize: true,
        title: { text: `Peak Demand - ${selectedDate}`, font: { size: 14 } },
        xaxis: {
          title: 'Time',
          type: 'date',
          tickformat: '%H:%M',
          automargin: true
        },
        yaxis: {
          title: 'Demand (kW)',
          automargin: true
        },
        margin: { l: 60, r: 20, t: 40, b: 60 },
        hoverlabel: { namelength: -1, font: { size: 13 } },
        hovermode: 'x unified',
        shapes: demandShapes
      }, plotlyConfig);

      document.getElementById('demand-period-legend').innerHTML =
        '<strong>Demand Charge Periods:</strong> ' + createLegendHtml(data.demand_periods);
    }

    // Date select change handler
    dateSelect.addEventListener('change', function() {
      const selectedDate = this.value;
      if (selectedDate) {
        renderDailyDetail(selectedDate);
      }
    });

    // Jump to Peak button handler
    peakBtn.addEventListener('click', function() {
      if (dailyDetail.peak_demand_day) {
        dateSelect.value = dailyDetail.peak_demand_day;
        renderDailyDetail(dailyDetail.peak_demand_day);
      }
    });

    // Auto-select peak day if available
    if (dailyDetail.peak_demand_day) {
      dateSelect.value = dailyDetail.peak_demand_day;
      renderDailyDetail(dailyDetail.peak_demand_day);
    }
  }
}) ();
</script>
{% endif %}

{% endif %}

{% endblock %}